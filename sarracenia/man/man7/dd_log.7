.TH DD_log "7" "Sep 2015" "sara 0.0.1" "Sarracenia Suite"
.SH NAME
dd_log \- Sarracenia dd_log v02 Log Message Format/Protocol
.SH SYNOPSIS
.nf 

.B AMQP Topic: <version>.log.<src>.{<dir>.}*<filename>
.B AMQP Headers: \fI<series of key-value pairs>\fR 
.B Body: \fI<first line>\fR = 
\fI<date stamp> <srcpath> <relpath> <newline>\fR
<\fIrest of body is reserved for future use\fR>

.fi


.SH DESCRIPTION
.PP
Sources create messages in the \fIdd_post\fR format to announce file changes. Subscribers 
read the post to decide whether a download of the content being announced is warranted.  
Subscribers may provide information to sources by sending a log message indicating the result 
of processing of a post.  The log message format is the posting echoed 
back to the source with a few small changes. Please consult the dd_post(7) man page for
a full explanation of the common fields.
.P

Messages use the UTF-8 character set exclusively. 
For more explanation of AMQP configuration choices, consult AMQP Feature Selection.

A dd_post message consists of four parts:
.nf

	AMQP TOPIC, First Line, Rest of Message, AMQP HEADERS.

.fi

.SH AMQP TOPIC

.P
The topic of a log message is similar to dd_post except that the second sub-topic is 'log' rather than 'post'.


.SH THE FIRST LINE 

.P
the first line of a message contains all mandatory elements of an dd_post(7) announcement.
There is a series of white space separated fields:

\fI<date stamp>\fR: the date the posting was emitted.  Format: YYYYMMDDHHMMSS.\fI<decimalseconds>\fR
 Note: The datestamp is always in UTC timezone.

\fI<srcpath>\fR -- the base URL used to retrieve the data.

This should be the URL consumers will use to download the data.  Example of a complete URL:

 sftp://afsiext@cmcdataserver/data/NRPDS/outputs/NRPDS_HiRes_000.gif

In the case where the URL does not end with a path separator ('/'), the src path is taken to be the complete source of the file to retrieve.

 Static URL: sftp://afsiext@cmcdataserver/

If the URL ends with a path separator ('/'), then the src URL is considered a prefix for the variable part of the retrieval URL.


\fI<relativepath>\fR  the variable part of the URL, usually appended to \fIsrcpath\fR.

.P
The above are the fields taken from the dd_post(7) format.  There are additional fields in the dd_log:


\fI<statuscode>\fR  a three digit status code, adopted from the HTTP protocol (w3.org/IETF RFC 2616) 

\fI<consuminghost>\fR  hostname from which the retrieval was initiated.

\fI<consuminguser>\fR  switch username from which the retrieval was initiated.

\fI<duration>\fR  how long processing took, in (decimal) seconds


\fI<newline>\fR signals the end of the first line of the message and is denoted by a single line feed character.

.fi

.SH THE REST OF MESSAGE

Use of only the first line of the AMQP payload is currently defined.  
The rest of the payload body is reserved for future use.

.SH AMQP HEADERS 
In addition to the first line of the message containing all mandatory fields, optional 
elements are stored in AMQP headers (key-value pairs), included in messages when 
appropriate.   In addition to the headers specified in the dd_post(7) manual page, the following log-specific headers are defined:

message=<msgstring>
.P
   An English textual representation of the status code. as per w3.org/IETF RFC 2616 Status Code Definitions.



.SH EXAMPLE

.nf 

topic: v02.post.ec_cmc.NRDPS.GIF.NRDPS_HiRes_000.gif
first line: 201506011357.345 sftp://afsiext@cmcdataserver/data/NRPDS/outputs/NRDPS_HiRes_000.gif NRDPS/GIF/ 201 castor anonymous 0.0006767 
headers: parts=p,457,1,0,0 sum=d,<md5sum> flow=exp13 message=Downloaded

        v02 - version of protocol
        post - indicates the type of message

        version and type together determine format of following topics and the message body.

        ec_cmc - the account used to issue the post (unique in a network).

          -- blocksize is 457  (== file size)
          -- block count is 1
          -- remainder is 0.
          -- block number is 0.
          -- d - checksum was calculated on the body of the file.
          -- flow is an argument after the relative path.
          -- complete source URL specified (does not end in '/')
          -- relative path specified for

        pull from:
                sftp://afsiext@cmcdataserver/data/NRPDS/outputs/NRDPS_HiRes_000.gif

        complete relative download path:
                NRDPS/GIF/NRDPS_HiRes_000.gif

                -- takes file name from srcpath.
                -- may be modified by validation process.

	message download succeeded (201) from host castor, as user anonymous, and took 0.006767 seconds.

.fi


.SH FURTHER READING

http://metpx.sf.net - home page of metpx-sarracenia

http://rabbitmq.net - home page of the AMQP broker used to develop Sarracenia.

.SH SEE ALSO

dd_get(1) - the multi-protocol download client.

dd_log2source(1) - copy log messages from the switch log bus to upstream destination.

dd_sara(1) - Subscribe and Re-advertise: A combined downstream an daisy-chain posting client.

dd_post(1) - the individual file posting client.

dd_post(7) - the format of log messages.

dd_subscribe(1) - the http-only download client.

dd_watch(1) - the directory watching daemon.

inotify(7) - used for file modification announcements on Linux.

