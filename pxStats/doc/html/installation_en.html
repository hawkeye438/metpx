<html>
<br>
<br>    """
<br>    MetPX Copyright (C) 2004-2006  Environment Canada
<br>    MetPX comes with ABSOLUTELY NO WARRANTY; For details type see the file 
<br>    named COPYING in the root of the source directory tree.
<br>    """
<br>    ################################################################################
<br>    #     _____          _        _ _       _   _             
<br>    #    |_   _|        | |      | | |     | | (_)            
<br>    #      | | _ __  ___| |_ __ _| | | __ _| |_ _  ___  _ __  
<br>    #      | || '_ \/ __| __/ _` | | |/ _` | __| |/ _ \| '_ \ 
<br>    #     _| || | | \__ \ || (_| | | | (_| | |_| | (_) | | | |
<br>    #     \___/_| |_|___/\__\__,_|_|_|\__,_|\__|_|\___/|_| |_|
<br>    #
<br>    #
<br>    # Author        : Nicholas Lemay
<br>    # Last Update   : October 16th 2007
<br>    #
<br>    ################################################################################
<br>    
<br>    
<br>    About this document :
<br>    --------------------------------------------------------------------------------
<br>    
<br>    The goal of this document is to give the proper knowledge to someone who would 
<br>    like to start up a new installation of the stats library.
<br>    
<br>    
<br>    Content:
<br>    --------------------------------------------------------------------------------
<br>    
<br>    Section 1.1 Requirements
<br>        Section 1.1.1 Software Requirements
<br>        Section 1.1.2 Hardware Requirements
<br>    
<br>    Section 2  : Installing as the first machine.
<br>            
<br>        Section 2.1 Required Files    
<br>        
<br>        Section 2.2 Configuration files
<br>            Section 2.2.1 Configuring the library
<br>            Section 2.2.2 Configuring the cleaner
<br>            Section 2.2.3 Configuring the statsMonitor
<br>        
<br>        Section 2.3 Setting up ssh
<br>        
<br>        Section 2.4 Setting up Crontabs      
<br>    
<br>        Section 2.5 Prior to the first crontab 
<br>        
<br>        
<br>    Section 3 : Installing as a mirror machine.
<br>        
<br>        Section 3.1 What needs to be downloaded    
<br>        
<br>        Section 3.2 What still needs to be set up 
<br>    
<br>    Section 4 : Setting up a machine so that data pickling is done on a remote machine.
<br>    
<br>    
<br>    Installation:
<br>    --------------------------------------------------------------------------------
<br>    
<br>    Section 1.1 Requirements
<br>    --------------------------------------------------------------------------------
<br>        
<br>        Section 1.1.1 Software Requirements
<br>        ----------------------------------------------------------------------------
<br>            Python     : version 2.3 or greater.
<br>            SSH        : Allows to connect and tranfer data /to/from other machines.
<br>            Rsync      : Allows to synchronise data between machines.
<br>            RRDTOOL    : Time-series storage and display system.
<br>            Python-rrd : Python package.
<br>            Gnuplot.py : Python package.
<br>        
<br>            
<br>        Section 1.1.2 Hardware Requirements
<br>        ----------------------------------------------------------------------------
<br>            
<br>            -> At least 7gb of disk space PER machine for wich you need the 
<br>            log files. Right now the machine with the most data takes up 6gb
<br>            but that number could keep on growing in the future.
<br>            
<br>            This space will be needed under ...pxstats/data/logFiles/ 
<br>            if pickling is done on the machine where orgininal logs reside. 
<br>            
<br>            Otherwise it will be under ...pxstats/data/logFiles/ if it is 
<br>            being done on a machine between the graphic producing machine and 
<br>            the log producing machine or if it is being done directly on the
<br>            graphic producing machine.
<br>                
<br>                
<br>            -> At least 1gb of disk space for graphics. Current cleaner configuration
<br>            and number of graphics, combined with the current number of 
<br>            client/sources keeps the space used under 1gb. That number could grow
<br>            indefinatly based on cleaner settings and a grwoing number of
<br>            client/sources.
<br>            
<br>            This space will be needed under ...pxstats/data/graphics/
<br>            
<br>            
<br>            -> At least 500 megs of disk space for databases. Right now the different 
<br>            databases take up 250 megs but a different consolidation configuration
<br>            or a growing number of client/sources could make this number climb up
<br>            greatly.
<br>            
<br>            This space will be needed under ...pxstats/data/databases/currentDatabases
<br>            
<br>                    
<br>            -> At least 6gb of disk space for database backups. We currently keep 20
<br>            backups saved at every 12 hours, wich gives us access to the saved 
<br>            data of the past 10 days. Saving every 12 hours helps us keep a 
<br>            limited number of backups while keeping the gap between backups small 
<br>            enough to hopefully keep data recevery times low.
<br>            
<br>            This space will be needed under .../pxStats/data/databases/databasesBackups
<br>            
<br>                
<br>            -> At least 10 gb of disk space per machine for wich you want to keep the
<br>            pickles. Currently we are averaging a 40 gig total for the pickles of 
<br>            21 days for 3 different machines. Keeping 10 days of pickles just like
<br>            10 days worth of database backups would be a good idea. 
<br>            40gigs/(21/10)/3 machines = 6.6 gigs, thus 10 gigs would be a good 
<br>            preventive minimum.
<br>            
<br>            This space will be needed under ../pxStats/data/pickles/
<br>            
<br>            
<br>            -> Some parts of the software were developped with a multi-processor 
<br>            machine architecture in mind. Perfomances will take a hit if program 
<br>            is run on a single processor machine.    
<br>            
<br>            
<br>            
<br>    Section 2  : Installing as the first machine.
<br>    --------------------------------------------------------------------------------
<br>        This section covers all required steps to install the stats library on a 
<br>        machine when no other machine are currently running the stats library.     
<br>    
<br>    
<br>        Section 2.1 Required Files
<br>        ----------------------------------------------------------------------------    
<br>            -> All the found under the .../pxStats/ folder 
<br>            wich can be downloaded here 
<br>            https://metpx.svn.sourceforge.net/svnroot/metpx/trunk/pxStats
<br>            
<br>            -> Python-rrd  : a Python package.
<br>            
<br>            -> Gnuplot.py  : a Python package.
<br>            
<br>            -> Logger.py   : usually found under /apps/px/lib/
<br>            
<br>            -> PXPaths.py  : usually found under /apps/px/lib/
<br>            
<br>            -> PXManager   : usually found under /apps/px/lib/
<br>            
<br>            -> readMaxFile : usually found under /apps/pds/tools/Columbo/ColumboShow/lib
<br>            
<br>            
<br>        Section 2.2 Configuration files
<br>        ----------------------------------------------------------------------------
<br>        
<br>            Section 2.2.1 Configuring the library
<br>            ------------------------------------------------------------------------
<br>                -> Go to the .../pxstats/etc folder.
<br>                
<br>                -> Download the config file template from
<br>                https://metpx.svn.sourceforge.net/svnroot/metpx/trunk/sundew/stats/etc
<br>                
<br>                -> Follow instructions found within file header.
<br>            
<br>            Section 2.2.2 Configuring the cleaners
<br>            ------------------------------------------------------------------------
<br>                
<br>                Section 2.2.2.1 Setting up .../pxstats/etc/clean.conf
<br>                --------------------------------------------------------------------
<br>                    -> Go to the .../pxstats/etc/ folder.
<br>                    -> Download the clean.conf file template from
<br>                    https://metpx.svn.sourceforge.net/svnroot/metpx/trunk/
<br>                    pxStats/etc/              
<br>                    -> Follow instructions found within file header.     
<br>                    
<br>                    Notes on the times used within the template : 
<br>                    ---------------------------------------------------------------        
<br>                    -> The only graphics wich should be cleaned up on a regular basis 
<br>                    are the ones found under .../pxstats/data/graphics/others.     
<br>                    
<br>                    -> Graphics in the other section should be kept since they are 
<br>                    part of those to be used within columbo's interface or
<br>                    within the web archives.
<br>                
<br>                
<br>                Section 2.2.2.1 Setting up the pickle Cleaner.
<br>                --------------------------------------------------------------------        
<br>                    -> Pickles age must be determined by the date that's included in
<br>                    their names and not their date of creation. Therefore a 
<br>                    special utility needs to be used within a crontab 
<br>                    to clean pickles.
<br>                    
<br>                    See section 2.4.x to find out how to set up the picklecleaner. 
<br>                    
<br>            
<br>            Section 2.2.3 Configuring the statsMonitor
<br>            ------------------------------------------------------------------------
<br>                -> Go to the .../pxstats/etc/ folder.
<br>                -> Download the statsMonitoring.conf file template from
<br>                https://metpx.svn.sourceforge.net/svnroot/metpx/trunk/
<br>                pxStats/etc/
<br>                -> Follow instructions found within file header.
<br>                
<br>                
<br>        Section 2.3 Setting up ssh
<br>        -----------------------------------------------------------------------------
<br>            When setting up the config file in the .../pxstats/etc/ folder
<br>            ( section 2.2.1 ) you can set up things so that different machine do 
<br>            different tasks. 
<br>            
<br>            For example, things can be set up so that a central machine(x) creates the
<br>            graphics, calls another machine(y) to do the pickling of data, wich in turn
<br>            calls another machine(z) to get the log files it needs. That would actually 
<br>            be the worst case scenario on the machine interconnectability scale.  
<br>            
<br>            To make sure everything works smoothly you need to set up
<br>            ssh connections between the machines wich have a dependance in a way 
<br>            that an ssh connection can be made using the client name specified 
<br>            in the config file WITHOUT having to enter a password.       
<br>                            
<br>        
<br>        Section 2.4 Setting up Crontabs      
<br>        -----------------------------------------------------------------------------
<br>            Here is a sample of a crontab file that's currently being run on 
<br>            a development machine :
<br>        
<br>            2  * * * * /apps/px/pxStats/bin/pxStatsStartup.py  > /dev/null 2>&1
<br>    
<br>            To obtain the listing of all the entries in the crontab of the machine 
<br>            you are setting up, type crontab -l.
<br>            
<br>            To edit this list, type crontab -e.
<br>            
<br>            Entries starting with the '#' character will be considered comment lines.
<br>            
<br>            
<br>            2.4.1 launchGraphCreation.py 
<br>            -------------------------------------------------------------------------
<br>            Needs to be run hourly. Choice of minute at wich it starts is arbitrary 
<br>            but it should be run at the top of the hour so that tasks have the time 
<br>            to end prior to the start of the following hour. 
<br>            
<br>            2.4.2 pickleCleaner.py 
<br>            -------------------------------------------------------------------------
<br>            The stats monitor expects us to keep at least 7 days worth of pickle 
<br>            files. In this example we keep 21 days worth of pickles. 
<br>            
<br>            This entry should be run once daily as to run the minimal amount of time 
<br>            that is needed to keep exactly x number of days worth of data.
<br>            
<br>            The hour selected is arbitrary, but choosing one when no monitoring is 
<br>            being run and no database backups are being done would be a wise choice 
<br>            as to keep machine load as evenly distributed as possible. 
<br>            
<br>            For the same reaosn, the minute choosen should not be at the very top 
<br>            of the hour as to not run at the same time as th graphic creation.   
<br>            
<br>            In the example we run it at the 20th minute of the first hour of every 
<br>            day wich respects both criteria.
<br>                    
<br>            
<br>            2.4.3 backupRRDDatabases.py 
<br>            -------------------------------------------------------------------------
<br>                This utility allows us to keep backups of rrd databases at different 
<br>                points in time. This way, if errors start polluting the data present 
<br>                in the databases, we can recuperate the saved state of the database 
<br>                prior to the start of the polluting or at least reduce the amount of 
<br>                time where incorrect data was fed to the databases.
<br>                
<br>                Database should NOT be saved every hour since transferring pickles 
<br>                to rrd databases is quite quick and backuping the databases every hour
<br>                would be overkill. Never the less, data bases shoudl be backed up at 
<br>                a frequency that will allow data retrieval to remain quick.
<br>                
<br>                In the above example it is saved eveyr 12 hours wich has proven to 
<br>                be a good compromise between the amount of space taken by the backups,
<br>                the number of time the backups are done per day and the time taken to
<br>                retreive data when something goes wrong. 
<br>                
<br>                
<br>                
<br>            2.4.4 .../pxStats/bin/tools/clean_dir.plx
<br>            -------------------------------------------------------------------------
<br>                This is the main cleaner used for cleanign all the artifacts created 
<br>                by the stats library.
<br>                
<br>                It should be run at a frequency wich will allow all the different 
<br>                entries found in to meet their cleaning frequnecy criteria.
<br>                
<br>                In the current configuration, the thing that gets cleaned up after
<br>                the least amount of time are files that are kept for 7 days. 
<br>                Therefore we run the utility daily. The choice to run it at the 45th
<br>                minute of the 18th hours was to meet the same 2 criterias that were 
<br>                expressed in section (2.4.2)
<br>                
<br>            
<br>            
<br>    Section 3: Installing as a second machine(or more) or as a mirror machine.
<br>    ---------------------------------------------------------------------------------
<br>        This section covers the different aspects that need to be covered to start up 
<br>        (or restart) a machine when another machine is currently producing graphics 
<br>        for the same machine as the one you want to start up.  
<br>    
<br>        
<br>        Section 3.1 What needs to be set up.    
<br>        -----------------------------------------------------------------------------
<br>            With such a machine, all the configuration files and the crontabs that 
<br>            are needed to be configured in a first machine still need to be 
<br>            configured.
<br>            
<br>            If a different set up is to be used( example remotely generated pickles 
<br>            vs locally generated pickles ) of if not all of the source machine will 
<br>            be handled by the two machines, a manual set up(section 3.1.1) is
<br>            required.
<br>            
<br>            Otherwise when the new machine will have the exact same behavior as the 
<br>            mirrored machine, a transfer of settings(section 3.1.2) should be done. 
<br>            
<br>            3.1.1 Settings things up manually.
<br>            -------------------------------------------------------------------------
<br>                Step 1 -> Open a console session to the allready running machine.
<br>                Step 2 -> Open a console session to the new machine. 
<br>                Step 3 -> Follow step 2.2 to 2.4 of this document.
<br>                Step 4 -> Copy all the parameters that seem usefull from the mirrored
<br>                        machine into the settings you are configuring on the new 
<br>                        machine.
<br>                Step 5 -> Add/modify/remove any parameters that is different from 
<br>                        the mirror machine.          
<br>                
<br>            3.1.2 Downloading remote parameters.
<br>            -------------------------------------------------------------------------
<br>                -> To have the exact same configuration files as a remote machine
<br>                you need to execute the following commands.
<br>                
<br>                scp login@remoteMachine:/apps/px/stats/config /apps/px/stats/config
<br>                scp login@remoteMachine:/apps/px/etc/cleaner.conf /apps/px/etc/cleaner.conf 
<br>                scp login@remoteMachine:/apps/px/stats/statsMonitoring/statsMonitoring.conf
<br>                /apps/px/stats/statsMonitoring/statsMonitoring.conf
<br>                
<br>                -> Some settings cannot be downloaded. The crontab entries 
<br>                of the remote machine will need to be copied on the local machine.
<br>                
<br>                -> Step 2.3 setting up ssh will also need to be done ion the exact 
<br>                same fashion as the mirrored machine on the local machine.  
<br>                
<br>        
<br>        Section 3.2 What needs to be downloaded.
<br>                (Also usefull when restarting a machine)    
<br>        ----------------------------------------------------------------------------- 
<br>            
<br>            3.2.1 On a mirror machine
<br>            -------------------------------------------------------------------------  
<br>                On a mirror machine a small utility allready exists wich will transfer
<br>                all the monitoring artifacts, pickles, graphs, databases, backups from 
<br>                one machine to another one.
<br>                
<br>                To use this utility use the following command : 
<br>                python /apps/px/lib/stats/retreiveDataFromMachine.py login remoteMachineName
<br>                
<br>                Please read warning on this utility prior to running it.
<br>                run this utility PRIOR to running any crontab entries( especially launchGraphCreation.)
<br>                
<br>                If for any reasons a long delay is to occur between the execution 
<br>                of this utility, and the first execution of the crontabs, rerun the
<br>                utility to make sure you have all the latest version of the different
<br>                files.  
<br>                
<br>                Note : /apps/px/stats/config needs to be configured PRIOR to calling 
<br>                    retreiveDataFromMachine.py. 
<br>                        
<br>                    ssh permissions also need to be set as to permit connection
<br>                    between local machine and mirrored machine without being asked
<br>                    for a password.
<br>            
<br>                
<br>            3.2.1 On a non-mirror machine
<br>            -------------------------------------------------------------------------
<br>                On a non mirror machine getting the files you require might prove to 
<br>                be a bit tricky...
<br>                
<br>                Here is a way to get all the type of files you need.
<br>                
<br>                Note : Make sure you have enough disk space before attempting to 
<br>                download all these files. Total disk space used can be considerable.
<br>                
<br>                3.2.1.1 Transferring log files :
<br>                ---------------------------------------------------------------------
<br>                You should only download the the log files of a particular machine 
<br>                if the local machine will be the one producing the pickles for that
<br>                particular machine.
<br>                
<br>                The command to use is this one :
<br>                rsync -avzr --delete-before -e ssh login@logProducingMachine:/apps/px/log/ 
<br>                /apps/px/log/logProducingMachine/ 
<br>                
<br>                3.2.1.2 Transferring monitoring artifacts :
<br>                ---------------------------------------------------------------------
<br>                This will only prove usefull if the 
<br>                
<br>                rsync -avzr  --delete-before -e ssh 
<br>                login@remoteMachine:/apps/px/stats/statsMonitoring/maxSettings.conf
<br>                /apps/px/stats/statsMonitoring/maxSettings.conf
<br>    
<br>                rsync -avzr  --delete-before -e ssh 
<br>                login@remoteMachine:/apps/px/stats/statsMonitoring/previousCrontab
<br>                /apps/px/stats/statsMonitoring/previousCrontab
<br>    
<br>                rsync -avzr  --delete-before -e ssh 
<br>                login@remoteMachine:/apps/px/stats/statsMonitoring/previousFileChecksums
<br>                /apps/px/stats/statsMonitoring/previousFileChecksums
<br>    
<br>                
<br>                3.2.1.2 Transferring graphics :
<br>                ---------------------------------------------------------------------
<br>            
<br>                rsync -avzr  --delete-before -e ssh login@remoteMachine:/apps/px/stats/graphs/
<br>                /apps/px/stats/graphs/
<br>                
<br>                Note : If the current machine does not handle all of the machines that
<br>                the source machine handles, you will be downloading some useless files.
<br>                Never the less, if disk space allows it, it will be much easier to 
<br>                download all the graphs instead of finding only the required ones. 
<br>                
<br>                3.2.1.2 Transferring pickles :
<br>                ---------------------------------------------------------------------                        
<br>                rsync -avzr  --delete-before -e ssh login@remoteMachine:/apps/px/stats/pickles/ 
<br>                /apps/px/stats/pickles/
<br>                
<br>                rsync -avzr  --delete-before -e ssh login@remoteMachine:/apps/px/stats/PICKLED-TIMES
<br>                /apps/px/stats/PICKLED-TIMES
<br>                
<br>                3.2.1.2 Transferring databases :
<br>                ---------------------------------------------------------------------                              
<br>                rsync -avzr  --delete-before -e ssh 
<br>                login@remoteMachine:/apps/px/stats/databases/ 
<br>                /apps/px/stats/databases/  
<br>                    
<br>                rsync -avzr  --delete-before -e ssh 
<br>                login@remoteMachine:/apps/px/stats/databases_backups/
<br>                /apps/px/stats/databases_backups/
<br>            
<br>                rsync -avzr  --delete-before -e ssh 
<br>                login@remoteMachine:/apps/px/stats/DATABASE-UPDATES/ 
<br>                /apps/px/stats/DATABASE-UPDATES/  
<br>            
<br>                rsync -avzr  --delete-before -e ssh 
<br>                login@remoteMachine:/apps/px/stats/DATABASE-UPDATES_BACKUPS/ 
<br>                /apps/px/stats/DATABASE-UPDATES_BACKUPS/
<br>    
<br>                
<br>                Transferring a huge amount of file might take a few hours.
<br>                This means that the first type of filed(ex : pickles ) will be 
<br>                missing some files by the time you finish to download the last type 
<br>                of files(ex : databases). This might cause inconstancy.
<br>                
<br>                To overcome this, run the commands in a specific sequence numerous times.
<br>                After a few times no new data will be present(except maybe for log files 
<br>                wich will not be a problem). This can be seen by analysing the output 
<br>                produced by the different rsync commands you have decided to run.
<br>                
<br>                
<br>                
<br>                
<br>    Section 4 : Setting up a remote machine for pickling.
<br>    ---------------------------------------------------------------------------------
<br>    
<br>        A remote machine used only for pickling will need the following :
<br>        
<br>        4.1 Required Files
<br>        -----------------------------------------------------------------------------    
<br>            -> All the found under the /apps/px/lib/stats/ folder 
<br>            wich can be downloaded here 
<br>            https://svn.sourceforge.net/svnroot/metpx/trunk/sundew/lib/stats/  
<br>                
<br>            -> Logger.py   : usually found under /apps/px/lib/
<br>                                
<br>            -> PXPaths.py  : usually found under /apps/px/lib/
<br>            
<br>            -> PXManager   : usually found under /apps/px/lib/
<br>            
<br>            All of wich can be downloaded here : 
<br>            https://svn.sourceforge.net/svnroot/metpx/trunk/sundew/lib/ 
<br>    
<br>            
<br>        4.2 Required disk space
<br>        -----------------------------------------------------------------------------
<br>            Depending on the number of handled machine, required disk space will vary
<br>            greatly. Consult section 1.1.2 for details.
<br>        
<br>            
<br>        4.3 Setting up ssh
<br>        ------------------------------------------------------------------------------    
<br>            SSH will minimally need to be set up so that the machine generating the 
<br>            graphics will be able to call the pickle generating machine without 
<br>            asking the user to enter a password.
<br>                
<br>            If the pickle generating machine is not the one producing the log files
<br>            it will also need a similar set up between itself and the log producing 
<br>        machine.
<br>    
<br>
<br></html><br>